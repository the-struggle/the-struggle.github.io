<!DOCTYPE HTML>
<!--
	Read Only by HTML5 UP
	html5up.net | @n33co
	Free for personal and commercial use under the CCA 3.0 license (html5up.net/license)
-->
<html>
    
	<head>
		<title>The Struggle is Real</title>
		<meta http-equiv="content-type" content="text/html; charset=utf-8" />
		<meta name="description" content="" />
		<meta name="keywords" content="" />
		<!--[if lte IE 8]><script src="css/ie/html5shiv.js"></script><![endif]-->
		<script src="/js/jquery.min.js"></script>
		<script src="/js/jquery.scrollzer.min.js"></script>
		<script src="/js/jquery.scrolly.min.js"></script>
		<script src="/js/skel.min.js"></script>
		<script src="/js/skel-layers.min.js"></script>
		<script src="/js/init.js"></script>
		<noscript>
			<link rel="stylesheet" href="/css/skel.css" />
			<link rel="stylesheet" href="/css/style.css" />
			<link rel="stylesheet" href="/css/style-xlarge.css" />
		</noscript>
		<!--[if lte IE 8]><link rel="stylesheet" href="css/ie/v8.css" /><![endif]-->
	</head>

    <body>
        <div id="wrapper">
        <!-- Header -->
    <section id="header" class="skel-layers-fixed">
        <header>
            <span class="image avatar"><img src="/images/avatar.jpg" alt="" /></span>
            <h1 id="logo"><a href="/">The Struggle</a></h1>
            <p>What the heck do I do next!?</p>
        </header>
        <nav id="nav">
            <ul>
                <li><a href="/">Home</a></li>
                <li><a href="/blog">Blog</a></li>
                <li>Contact: the.struggle.1 at gmail.com</li>
            </ul>
        </nav>
        <footer>
            <ul class="icons">
<!--                <li><a href="#" class="icon fa-twitter"><span class="label">Twitter</span></a></li>
-->
<!--                <li><a href="#" class="icon fa-facebook"><span class="label">Facebook</span></a></li>
-->
<!--                <li><a href="#" class="icon fa-instagram"><span class="label">Instagram</span></a></li>
-->
                <li><a href="#" class="icon fa-github"><span class="label">Github</span></a></li>
<!--                <li><a href="#" class="icon fa-envelope"><span class="label">Email</span></a></li>
-->
            </ul>
        </footer>
    </section>


            <!-- Main -->
            <div id="main">
                <section>
    <div class="container">
        <header class="major">
            <h2>Back to moving averages.</h2>
                <p class="post-meta">Aug 10, 2018</p>
        </header>

        <section class="post-content">
            <p>Soooooo, I kind of fell off the wagon and haven’t posted here in over a week. For good reason though! Worky reasons. In any case, I’m back and today I’m following up on moving average crossover.</p>

<p>Last time I wrote about a moving average cross over strategy, which didn’t quite seem to work. I just want to touch back on this and point out why I think this wasn’t working. First of all, the portfolio was only investing one tenth of its cash, so of course returns were low! Here’s the code to reproduce the same graphs and statistics:</p>

<p>```python
import pandas as pd
pd.core.common.is_list_like = pd.api.types.is_list_like
from pandas_datareader import data
import numpy as np
import fix_yahoo_finance as yf
import matplotlib.pyplot as plt
%matplotlib inline</p>

<p>yf.pdr_override()</p>

<h1 id="download-data">Download data</h1>
<p>symbol = ‘SPY’
start_date = ‘2010-01-01’
end_date = ‘2016-01-01’
df = data.get_data_yahoo(symbol, start_date, end_date)</p>

<h1 id="set-some-parameters">Set some parameters</h1>
<p>short_average = 20
long_average = 30</p>

<h1 id="compute-the-moving-averages-and-add-to-dataframe">Compute the moving averages and add to dataframe</h1>
<p># We’ll base them on the open
ma_columns = [‘MA’ + str(short_average), ‘MA’ + str(long_average)]
df[ma_columns[0]] = df.Open.rolling(short_average).mean()
df[ma_columns[1]] = df.Open.rolling(long_average).mean()</p>

<p>df[‘hold’] = 0
# We want to hold the stock when the short is above the long
df[‘hold’].iloc[long_average:] = \
    np.where(df[ma_columns[0]].iloc[long_average:] &gt;
             df[ma_columns[1]].iloc[long_average:], 1.0, 0.0)
# We buy/sell when this holding changes, so we can simply
# first difference it to get the signal
df[‘signal’] = df[‘hold’].diff()</p>

<h1 id="how-much-money-should-we-start-with">How much money should we start with?</h1>
<p>initial_capital = 10000.0</p>

<h1 id="construct-our-position-as-10-shares-depending-on-our-hold">Construct our position as 10 shares depending on our hold</h1>
<p>shares = 10
positions = df[‘hold’]*shares</p>

<h1 id="compute-holdings-as-position-times-open-price-what-we-assume">Compute holdings as position times open price (what we assume</h1>
<p># we buy and sell at)
portfolio = pd.DataFrame()
portfolio[‘holdings’] = positions.multiply(df[‘Open’], axis=0)</p>

<h1 id="add-a-cash-column-to-our-portfolio-this-is-our-starting">Add a cash column to our portfolio. This is our starting</h1>
<p># salary less the purchase or sale of assets
portfolio[‘cash’] = initial_capital - (positions.diff().fillna(0.0).multiply(df.Open)).cumsum()</p>

<h1 id="compute-the-portfolio-value">Compute the portfolio value</h1>
<p>portfolio[‘total’] = portfolio.sum(axis=1)</p>

<h1 id="compute-percent-returns-per-day-and-over-the-lifetime">Compute percent returns per day and over the lifetime</h1>
<p>portfolio.fillna(0.0)
portfolio[‘daily_ret’] = portfolio[‘total’].pct_change()
portfolio[‘cum_ret’] = (1 + portfolio[‘daily_ret’]).cumprod()</p>

<p>portfolio.total.plot()
```</p>

<div class="highlighter-rouge"><pre class="highlight"><code>[*********************100%***********************]  1 of 1 downloaded


/home/tmabbot/anaconda3/lib/python3.6/site-packages/pandas/core/indexing.py:194: SettingWithCopyWarning:
A value is trying to be set on a copy of a slice from a DataFrame

See the caveats in the documentation: http://pandas.pydata.org/pandas-docs/stable/indexing.html#indexing-view-versus-copy
  self._setitem_with_indexer(indexer, value)





&lt;matplotlib.axes._subplots.AxesSubplot at 0x7f387c3eabe0&gt;
</code></pre>
</div>

<p><img src="notebook_files/notebook_1_3.png" alt="png" /></p>

<p><code class="highlighter-rouge">python
df[['Open', ma_columns[0], ma_columns[1]]].plot()
</code></p>

<div class="highlighter-rouge"><pre class="highlight"><code>&lt;matplotlib.axes._subplots.AxesSubplot at 0x7f387c5e75f8&gt;
</code></pre>
</div>

<p><img src="notebook_files/notebook_2_1.png" alt="png" /></p>

<p>This strategy makes only four percent in six years, while just buying and holding makes 80 percent. Just increasing the number of shares will produce nearly 50 percent returns over the period.</p>

<p>One issue is that two moving averages ignores that there are different wave-lengths of signal here. We can take this into account by adding a third moving average.</p>

<p>```python
# Set some parameters
long_long_average = 100</p>

<h1 id="compute-the-moving-averages-and-add-to-dataframe-1">Compute the moving averages and add to dataframe</h1>
<p># We’ll base them on the open
ma_columns.append(‘MA’ + str(long_long_average))
df[ma_columns[2]] = df.Open.rolling(long_long_average).mean()
df[‘hold’] = 0</p>

<h1 id="we-want-to-hold-the-stock-when-the-short-is-above-the-long-and-the">We want to hold the stock when the short is above the long AND the</h1>
<p># long is above the longlong
df[‘hold’].iloc[long_long_average:] = \
    np.where((df[ma_columns[0]].iloc[long_long_average:] &gt;
              df[ma_columns[1]].iloc[long_long_average:]) &amp;
             (df[ma_columns[1]].iloc[long_long_average:] &gt;
              df[ma_columns[2]].iloc[long_long_average:]), 1.0, 0.0)</p>

<h1 id="we-buysell-when-this-holding-changes-so-we-can-simply">We buy/sell when this holding changes, so we can simply</h1>
<p># first difference it to get the signal
df[‘signal’] = df[‘hold’].diff()</p>

<h1 id="how-much-money-should-we-start-with-1">How much money should we start with?</h1>
<p>initial_capital = 1000.0</p>

<h1 id="construct-our-position-as-10-shares-depending-on-our-hold-1">Construct our position as 10 shares depending on our hold</h1>
<p>shares = 10
positions = df[‘hold’]*shares</p>

<h1 id="compute-holdings-as-position-times-open-price-what-we-assume-1">Compute holdings as position times open price (what we assume</h1>
<p># we buy and sell at)
portfolio = pd.DataFrame()
portfolio[‘holdings’] = positions.multiply(df[‘Open’], axis=0)</p>

<h1 id="add-a-cash-column-to-our-portfolio-this-is-our-starting-1">Add a cash column to our portfolio. This is our starting</h1>
<p># salary less the purchase or sale of assets
portfolio[‘cash’] = initial_capital - positions.diff().fillna(0.0).multiply(df[‘Open’]).cumsum()</p>

<h1 id="compute-the-portfolio-value-1">Compute the portfolio value</h1>
<p>portfolio[‘total’] = portfolio[‘holdings’] +  portfolio[‘cash’]
#portfolio[‘total’] = portfolio.sum(axis=1)
# Compute percent returns per day and over the lifetime
portfolio.fillna(0.0)
portfolio[‘daily_ret’] = portfolio[‘total’].pct_change()
portfolio[‘cum_ret’] = (1 + portfolio[‘daily_ret’]).cumprod()</p>

<p>portfolio.total.plot()
```</p>

<div class="highlighter-rouge"><pre class="highlight"><code>/home/tmabbot/anaconda3/lib/python3.6/site-packages/pandas/core/indexing.py:194: SettingWithCopyWarning:
A value is trying to be set on a copy of a slice from a DataFrame

See the caveats in the documentation: http://pandas.pydata.org/pandas-docs/stable/indexing.html#indexing-view-versus-copy
  self._setitem_with_indexer(indexer, value)





&lt;matplotlib.axes._subplots.AxesSubplot at 0x7f387c32e320&gt;
</code></pre>
</div>

<p><img src="notebook_files/notebook_4_2.png" alt="png" /></p>

<p><code class="highlighter-rouge">python
# What would we have earned if we bought and held?
(df['Open'].iloc[-1] - df['Open'].iloc[0])/df['Open'].iloc[0]
</code></p>

<div class="highlighter-rouge"><pre class="highlight"><code>0.8190122413499754
</code></pre>
</div>

<p>In addition, as the value of the portfolio rises, we are not fully invested:</p>

<p><code class="highlighter-rouge">python
portfolio.iloc[-100:-50]
</code></p>

<div>
<style scoped="">
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>holdings</th>
      <th>cash</th>
      <th>total</th>
      <th>daily_ret</th>
      <th>cum_ret</th>
    </tr>
    <tr>
      <th>Date</th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>2015-08-11</th>
      <td>0.0</td>
      <td>1510.29953</td>
      <td>1510.29953</td>
      <td>0.0</td>
      <td>1.5103</td>
    </tr>
    <tr>
      <th>2015-08-12</th>
      <td>0.0</td>
      <td>1510.29953</td>
      <td>1510.29953</td>
      <td>0.0</td>
      <td>1.5103</td>
    </tr>
    <tr>
      <th>2015-08-13</th>
      <td>0.0</td>
      <td>1510.29953</td>
      <td>1510.29953</td>
      <td>0.0</td>
      <td>1.5103</td>
    </tr>
    <tr>
      <th>2015-08-14</th>
      <td>0.0</td>
      <td>1510.29953</td>
      <td>1510.29953</td>
      <td>0.0</td>
      <td>1.5103</td>
    </tr>
    <tr>
      <th>2015-08-17</th>
      <td>0.0</td>
      <td>1510.29953</td>
      <td>1510.29953</td>
      <td>0.0</td>
      <td>1.5103</td>
    </tr>
    <tr>
      <th>2015-08-18</th>
      <td>0.0</td>
      <td>1510.29953</td>
      <td>1510.29953</td>
      <td>0.0</td>
      <td>1.5103</td>
    </tr>
    <tr>
      <th>2015-08-19</th>
      <td>0.0</td>
      <td>1510.29953</td>
      <td>1510.29953</td>
      <td>0.0</td>
      <td>1.5103</td>
    </tr>
    <tr>
      <th>2015-08-20</th>
      <td>0.0</td>
      <td>1510.29953</td>
      <td>1510.29953</td>
      <td>0.0</td>
      <td>1.5103</td>
    </tr>
    <tr>
      <th>2015-08-21</th>
      <td>0.0</td>
      <td>1510.29953</td>
      <td>1510.29953</td>
      <td>0.0</td>
      <td>1.5103</td>
    </tr>
    <tr>
      <th>2015-08-24</th>
      <td>0.0</td>
      <td>1510.29953</td>
      <td>1510.29953</td>
      <td>0.0</td>
      <td>1.5103</td>
    </tr>
    <tr>
      <th>2015-08-25</th>
      <td>0.0</td>
      <td>1510.29953</td>
      <td>1510.29953</td>
      <td>0.0</td>
      <td>1.5103</td>
    </tr>
    <tr>
      <th>2015-08-26</th>
      <td>0.0</td>
      <td>1510.29953</td>
      <td>1510.29953</td>
      <td>0.0</td>
      <td>1.5103</td>
    </tr>
    <tr>
      <th>2015-08-27</th>
      <td>0.0</td>
      <td>1510.29953</td>
      <td>1510.29953</td>
      <td>0.0</td>
      <td>1.5103</td>
    </tr>
    <tr>
      <th>2015-08-28</th>
      <td>0.0</td>
      <td>1510.29953</td>
      <td>1510.29953</td>
      <td>0.0</td>
      <td>1.5103</td>
    </tr>
    <tr>
      <th>2015-08-31</th>
      <td>0.0</td>
      <td>1510.29953</td>
      <td>1510.29953</td>
      <td>0.0</td>
      <td>1.5103</td>
    </tr>
    <tr>
      <th>2015-09-01</th>
      <td>0.0</td>
      <td>1510.29953</td>
      <td>1510.29953</td>
      <td>0.0</td>
      <td>1.5103</td>
    </tr>
    <tr>
      <th>2015-09-02</th>
      <td>0.0</td>
      <td>1510.29953</td>
      <td>1510.29953</td>
      <td>0.0</td>
      <td>1.5103</td>
    </tr>
    <tr>
      <th>2015-09-03</th>
      <td>0.0</td>
      <td>1510.29953</td>
      <td>1510.29953</td>
      <td>0.0</td>
      <td>1.5103</td>
    </tr>
    <tr>
      <th>2015-09-04</th>
      <td>0.0</td>
      <td>1510.29953</td>
      <td>1510.29953</td>
      <td>0.0</td>
      <td>1.5103</td>
    </tr>
    <tr>
      <th>2015-09-08</th>
      <td>0.0</td>
      <td>1510.29953</td>
      <td>1510.29953</td>
      <td>0.0</td>
      <td>1.5103</td>
    </tr>
    <tr>
      <th>2015-09-09</th>
      <td>0.0</td>
      <td>1510.29953</td>
      <td>1510.29953</td>
      <td>0.0</td>
      <td>1.5103</td>
    </tr>
    <tr>
      <th>2015-09-10</th>
      <td>0.0</td>
      <td>1510.29953</td>
      <td>1510.29953</td>
      <td>0.0</td>
      <td>1.5103</td>
    </tr>
    <tr>
      <th>2015-09-11</th>
      <td>0.0</td>
      <td>1510.29953</td>
      <td>1510.29953</td>
      <td>0.0</td>
      <td>1.5103</td>
    </tr>
    <tr>
      <th>2015-09-14</th>
      <td>0.0</td>
      <td>1510.29953</td>
      <td>1510.29953</td>
      <td>0.0</td>
      <td>1.5103</td>
    </tr>
    <tr>
      <th>2015-09-15</th>
      <td>0.0</td>
      <td>1510.29953</td>
      <td>1510.29953</td>
      <td>0.0</td>
      <td>1.5103</td>
    </tr>
    <tr>
      <th>2015-09-16</th>
      <td>0.0</td>
      <td>1510.29953</td>
      <td>1510.29953</td>
      <td>0.0</td>
      <td>1.5103</td>
    </tr>
    <tr>
      <th>2015-09-17</th>
      <td>0.0</td>
      <td>1510.29953</td>
      <td>1510.29953</td>
      <td>0.0</td>
      <td>1.5103</td>
    </tr>
    <tr>
      <th>2015-09-18</th>
      <td>0.0</td>
      <td>1510.29953</td>
      <td>1510.29953</td>
      <td>0.0</td>
      <td>1.5103</td>
    </tr>
    <tr>
      <th>2015-09-21</th>
      <td>0.0</td>
      <td>1510.29953</td>
      <td>1510.29953</td>
      <td>0.0</td>
      <td>1.5103</td>
    </tr>
    <tr>
      <th>2015-09-22</th>
      <td>0.0</td>
      <td>1510.29953</td>
      <td>1510.29953</td>
      <td>0.0</td>
      <td>1.5103</td>
    </tr>
    <tr>
      <th>2015-09-23</th>
      <td>0.0</td>
      <td>1510.29953</td>
      <td>1510.29953</td>
      <td>0.0</td>
      <td>1.5103</td>
    </tr>
    <tr>
      <th>2015-09-24</th>
      <td>0.0</td>
      <td>1510.29953</td>
      <td>1510.29953</td>
      <td>0.0</td>
      <td>1.5103</td>
    </tr>
    <tr>
      <th>2015-09-25</th>
      <td>0.0</td>
      <td>1510.29953</td>
      <td>1510.29953</td>
      <td>0.0</td>
      <td>1.5103</td>
    </tr>
    <tr>
      <th>2015-09-28</th>
      <td>0.0</td>
      <td>1510.29953</td>
      <td>1510.29953</td>
      <td>0.0</td>
      <td>1.5103</td>
    </tr>
    <tr>
      <th>2015-09-29</th>
      <td>0.0</td>
      <td>1510.29953</td>
      <td>1510.29953</td>
      <td>0.0</td>
      <td>1.5103</td>
    </tr>
    <tr>
      <th>2015-09-30</th>
      <td>0.0</td>
      <td>1510.29953</td>
      <td>1510.29953</td>
      <td>0.0</td>
      <td>1.5103</td>
    </tr>
    <tr>
      <th>2015-10-01</th>
      <td>0.0</td>
      <td>1510.29953</td>
      <td>1510.29953</td>
      <td>0.0</td>
      <td>1.5103</td>
    </tr>
    <tr>
      <th>2015-10-02</th>
      <td>0.0</td>
      <td>1510.29953</td>
      <td>1510.29953</td>
      <td>0.0</td>
      <td>1.5103</td>
    </tr>
    <tr>
      <th>2015-10-05</th>
      <td>0.0</td>
      <td>1510.29953</td>
      <td>1510.29953</td>
      <td>0.0</td>
      <td>1.5103</td>
    </tr>
    <tr>
      <th>2015-10-06</th>
      <td>0.0</td>
      <td>1510.29953</td>
      <td>1510.29953</td>
      <td>0.0</td>
      <td>1.5103</td>
    </tr>
    <tr>
      <th>2015-10-07</th>
      <td>0.0</td>
      <td>1510.29953</td>
      <td>1510.29953</td>
      <td>0.0</td>
      <td>1.5103</td>
    </tr>
    <tr>
      <th>2015-10-08</th>
      <td>0.0</td>
      <td>1510.29953</td>
      <td>1510.29953</td>
      <td>0.0</td>
      <td>1.5103</td>
    </tr>
    <tr>
      <th>2015-10-09</th>
      <td>0.0</td>
      <td>1510.29953</td>
      <td>1510.29953</td>
      <td>0.0</td>
      <td>1.5103</td>
    </tr>
    <tr>
      <th>2015-10-12</th>
      <td>0.0</td>
      <td>1510.29953</td>
      <td>1510.29953</td>
      <td>0.0</td>
      <td>1.5103</td>
    </tr>
    <tr>
      <th>2015-10-13</th>
      <td>0.0</td>
      <td>1510.29953</td>
      <td>1510.29953</td>
      <td>0.0</td>
      <td>1.5103</td>
    </tr>
    <tr>
      <th>2015-10-14</th>
      <td>0.0</td>
      <td>1510.29953</td>
      <td>1510.29953</td>
      <td>0.0</td>
      <td>1.5103</td>
    </tr>
    <tr>
      <th>2015-10-15</th>
      <td>0.0</td>
      <td>1510.29953</td>
      <td>1510.29953</td>
      <td>0.0</td>
      <td>1.5103</td>
    </tr>
    <tr>
      <th>2015-10-16</th>
      <td>0.0</td>
      <td>1510.29953</td>
      <td>1510.29953</td>
      <td>0.0</td>
      <td>1.5103</td>
    </tr>
    <tr>
      <th>2015-10-19</th>
      <td>0.0</td>
      <td>1510.29953</td>
      <td>1510.29953</td>
      <td>0.0</td>
      <td>1.5103</td>
    </tr>
    <tr>
      <th>2015-10-20</th>
      <td>0.0</td>
      <td>1510.29953</td>
      <td>1510.29953</td>
      <td>0.0</td>
      <td>1.5103</td>
    </tr>
  </tbody>
</table>
</div>

<p><code class="highlighter-rouge">python
# To see how this works we can plot our processes and signal
below = 0
truncate=1500
fig, ax = plt.subplots(1, 1)
df[['Open', ma_columns[0], ma_columns[1], ma_columns[2]]].iloc[below:truncate].plot(ax=ax)
ax.plot(df.loc[df.signal==1.0].index,
        df[ma_columns[0]].loc[df.signal==1.0],
       '^', color='g', markersize=10)
ax.plot(df.loc[df.signal==-1.0].index,
        df[ma_columns[0]].loc[df.signal==-1.0],
       'v', color='r', markersize=10)
ax.set_ylim(100, 220)
ax.set_xlim(df.index[below], df.index[truncate])
plt.show()
</code></p>

<p><img src="notebook_files/notebook_8_0.png" alt="png" /></p>

<p>Now we are only buying and selling on up-trends. One thing that still confuses me is why this strategy wouldn’t make as much as if we just invested everything from the start and held on…</p>

        </section>
        
        <footer>
            
            <a href="/update/2018/08/10/backtrader.html" class="float-left">&larr; Previous post</a> 
            
        </footer>

    </div>

</section>


            </div>
            <!-- Footer -->
    <section id="footer">
        <div class="container">
            <ul class="copyright">
<!--               <li>&copy; Untitled. All rights reserved.</li>
-->
                <li>Design: <a href="http://html5up.net">HTML5 UP</a></li>
                <li>Jekyll Template: <a target="_blank" href="https://github.com/old-jekyll-templates/Read-Only-Jekyll-Theme">Read Only</a></li>
            </ul>
        </div>
    </section>

		</div>
	</body>
</html>